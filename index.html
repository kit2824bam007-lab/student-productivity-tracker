<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Productivity Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      :root {
        --primary: #4361ee;
        --secondary: #3a0ca3;
        --accent: #4cc9f0;
        --light: #f8f9fa;
        --dark: #212529;
        --success: #4ade80;
        --warning: #f59e0b;
        --danger: #ef4444;
        --gray: #6c757d;
      }

      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .auth-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
      }

      .auth-box {
        background: rgba(255, 255, 255, 0.95);
        padding: 40px;
        border-radius: 15px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 450px;
      }

      .auth-header {
        text-align: center;
        margin-bottom: 30px;
      }

      .auth-header i {
        font-size: 3rem;
        color: var(--primary);
        margin-bottom: 15px;
      }

      .auth-header h1 {
        color: var(--dark);
        margin-bottom: 10px;
      }

      .auth-header p {
        color: var(--gray);
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: var(--dark);
        font-weight: 500;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1rem;
        transition: border 0.3s;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: var(--primary);
      }

      .auth-btn {
        width: 100%;
        padding: 12px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        transition: background 0.3s;
        margin-top: 10px;
      }

      .auth-btn:hover {
        background: var(--secondary);
      }

      .auth-link {
        text-align: center;
        margin-top: 20px;
      }

      .auth-link a {
        color: var(--primary);
        text-decoration: none;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        display: none;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(255, 255, 255, 0.95);
        padding: 20px 30px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        margin-bottom: 25px;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .logo i {
        font-size: 2.5rem;
        color: var(--primary);
      }

      .logo h1 {
        font-size: 1.8rem;
        color: var(--dark);
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 1.2rem;
      }

      .nav-tabs {
        display: flex;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 10px;
        margin-bottom: 25px;
        overflow-x: auto;
      }

      .nav-tab {
        padding: 12px 20px;
        border: none;
        background: transparent;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .nav-tab.active {
        background: var(--primary);
        color: white;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .dashboard {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 25px;
        margin-bottom: 25px;
      }

      .card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
      }

      .stat-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s;
      }

      .stat-card:hover {
        transform: translateY(-5px);
      }

      .stat-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: var(--primary);
        margin: 10px 0;
      }

      .stat-label {
        color: var(--gray);
        font-size: 0.9rem;
      }

      .progress-ring {
        position: relative;
        width: 120px;
        height: 120px;
        margin: 0 auto;
      }

      .progress-ring circle {
        fill: none;
        stroke-width: 10;
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
      }

      .progress-ring-bg {
        stroke: #e9ecef;
      }

      .progress-ring-progress {
        stroke: var(--primary);
        stroke-dasharray: 314;
        stroke-dashoffset: 314;
        transition: stroke-dashoffset 1s ease;
      }

      .progress-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.8rem;
        font-weight: bold;
        color: var(--primary);
      }

      .chart-container {
        height: 300px;
        margin-top: 20px;
      }

      h2 {
        color: var(--dark);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      h2 i {
        color: var(--primary);
      }

      .features {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 25px;
      }

      .chat-container {
        display: flex;
        flex-direction: column;
        height: 500px;
      }

      .chat-header {
        padding: 15px;
        background: var(--primary);
        color: white;
        border-radius: 10px 10px 0 0;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .chat-messages {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        background: #f1f3f9;
        border-left: 1px solid #e0e0e0;
        border-right: 1px solid #e0e0e0;
      }

      .message {
        margin-bottom: 15px;
        display: flex;
      }

      .message.user {
        justify-content: flex-end;
      }

      .message-bubble {
        max-width: 70%;
        padding: 12px 15px;
        border-radius: 18px;
      }

      .message.bot .message-bubble {
        background: white;
        border-top-left-radius: 5px;
      }

      .message.user .message-bubble {
        background: var(--primary);
        color: white;
        border-top-right-radius: 5px;
      }

      .chat-input {
        display: flex;
        padding: 15px;
        background: white;
        border-radius: 0 0 10px 10px;
        border: 1px solid #e0e0e0;
        border-top: none;
      }

      .chat-input input {
        flex: 1;
        padding: 12px 15px;
        border: 1px solid #e0e0e0;
        border-radius: 25px;
        outline: none;
      }

      .chat-input button {
        margin-left: 10px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .search-container {
        display: flex;
        margin-bottom: 15px;
      }

      .search-container input {
        flex: 1;
        padding: 12px 15px;
        border: 1px solid #e0e0e0;
        border-radius: 25px 0 0 25px;
        outline: none;
      }

      .search-container button {
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 0 25px 25px 0;
        padding: 0 20px;
        cursor: pointer;
      }

      .search-results {
        margin-top: 15px;
      }

      .result-item {
        background: white;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 10px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
      }

      .result-title {
        font-weight: bold;
        margin-bottom: 5px;
        color: var(--dark);
      }

      .result-meta {
        display: flex;
        justify-content: space-between;
        color: var(--gray);
        font-size: 0.8rem;
      }

      .usage-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }

      .usage-controls button {
        padding: 10px 15px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        flex: 1;
      }

      .usage-controls button:hover {
        background: var(--secondary);
      }

      .mobile-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-top: 20px;
      }

      .mobile-stat {
        background: white;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
      }

      .mobile-stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--primary);
        margin: 5px 0;
      }

      .mobile-stat-label {
        color: var(--gray);
        font-size: 0.8rem;
      }

      .table-container {
        overflow-x: auto;
        margin-top: 20px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
      }

      th,
      td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
      }

      th {
        background: #f8f9fa;
        font-weight: 600;
        color: var(--dark);
      }

      tr:hover {
        background: #f8f9fa;
      }

      .badge {
        padding: 4px 8px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .badge-success {
        background: #e8f5e8;
        color: #2e7d32;
      }

      .badge-warning {
        background: #fff3cd;
        color: #856404;
      }

      .badge-info {
        background: #e3f2fd;
        color: #1565c0;
      }

      .platform-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-top: 20px;
      }

      .platform-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
      }

      .platform-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
      }

      .platform-header i {
        font-size: 1.5rem;
      }

      .leetcode i {
        color: #ffa116;
      }

      .codechef i {
        color: #7c3aed;
      }

      .prediction-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 15px;
        margin-top: 20px;
      }

      .prediction-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 10px 0;
      }

      @media (max-width: 900px) {
        .dashboard,
        .features,
        .stats-grid,
        .platform-stats {
          grid-template-columns: 1fr;
        }
      }

      .admin-panel {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 25px;
      }

      .test-credentials {
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 1000;
      }

      .test-btn {
        background: var(--success);
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
    </style>
  </head>

  <body>
    <!-- Test Credentials Button -->
    <div class="test-credentials">
      <button class="test-btn" onclick="fillTestCredentials()">
        Fill Test Data
      </button>
    </div>

    <!-- Login Page -->
    <div class="auth-container" id="loginPage">
      <div class="auth-box">
        <div class="auth-header">
          <i class="fas fa-graduation-cap"></i>
          <h1>Student Login</h1>
          <p>Access your productivity dashboard</p>
        </div>
        <form id="loginForm">
          <div class="form-group">
            <label for="loginEmail">Email Address</label>
            <input
              type="email"
              id="loginEmail"
              placeholder="Enter your email"
              required
            />
          </div>
          <div class="form-group">
            <label for="loginPassword">Password</label>
            <input
              type="password"
              id="loginPassword"
              placeholder="Enter your password"
              required
            />
          </div>
          <button type="submit" class="auth-btn">Login</button>
        </form>
        <div class="auth-link">
          <p>
            Don't have an account?
            <a href="#" onclick="showRegister()">Register here</a>
          </p>
        </div>
      </div>
    </div>

    <!-- Registration Page -->
    <div class="auth-container" id="registerPage" style="display: none">
      <div class="auth-box">
        <div class="auth-header">
          <i class="fas fa-user-plus"></i>
          <h1>Student Registration</h1>
          <p>Join our productivity tracking platform</p>
        </div>
        <form id="registerForm">
          <div class="form-group">
            <label for="regName">Full Name</label>
            <input
              type="text"
              id="regName"
              placeholder="Enter your full name"
              required
            />
          </div>
          <div class="form-group">
            <label for="regEmail">Email Address</label>
            <input
              type="email"
              id="regEmail"
              placeholder="Enter your email"
              required
            />
          </div>
          <div class="form-group">
            <label for="regPassword">Password</label>
            <input
              type="password"
              id="regPassword"
              placeholder="Create a password"
              required
            />
          </div>
          <div class="form-group">
            <label for="regCourse">Primary Course</label>
            <select id="regCourse" required>
              <option value="">Select your course</option>
              <option value="Computer Science">Computer Science</option>
              <option value="Data Science">Data Science</option>
              <option value="Engineering">Engineering</option>
              <option value="Business">Business</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <button type="submit" class="auth-btn">Register</button>
        </form>
        <div class="auth-link">
          <p>
            Already have an account?
            <a href="#" onclick="showLogin()">Login here</a>
          </p>
        </div>
      </div>
    </div>

    <!-- Main Dashboard -->
    <div class="container" id="dashboard">
      <header>
        <div class="logo">
          <i class="fas fa-graduation-cap"></i>
          <h1>Student Productivity Tracker</h1>
        </div>
        <div class="user-info">
          <div class="avatar" id="userAvatar">JS</div>
          <div>
            <div class="user-name" id="userName">John Student</div>
            <div class="user-email" id="userEmail">john@student.com</div>
          </div>
          <button
            class="auth-btn"
            onclick="logout()"
            style="width: auto; padding: 8px 15px"
          >
            Logout
          </button>
        </div>
      </header>

      <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('dashboardTab')">
          <i class="fas fa-tachometer-alt"></i> Dashboard
        </button>
        <button class="nav-tab" onclick="switchTab('profileTab')">
          <i class="fas fa-user"></i> Profile
        </button>
        <button class="nav-tab" onclick="switchTab('coursesTab')">
          <i class="fas fa-book"></i> Courses & Certificates
        </button>
        <button class="nav-tab" onclick="switchTab('codingTab')">
          <i class="fas fa-code"></i> Coding Platforms
        </button>
        <button class="nav-tab" onclick="switchTab('eventsTab')">
          <i class="fas fa-calendar-alt"></i> Events
        </button>
        <button class="nav-tab" onclick="switchTab('rankingTab')">
          <i class="fas fa-trophy"></i> Rankings
        </button>
        <button class="nav-tab" onclick="switchTab('adminTab')">
          <i class="fas fa-cog"></i> Admin Panel
        </button>
      </div>

      <!-- Dashboard Tab -->
      <div class="tab-content active" id="dashboardTab">
        <div class="dashboard">
          <div class="card">
            <h2>
              <i class="fas fa-tachometer-alt"></i> Productivity Dashboard
            </h2>
            <div class="stats-grid">
              <div class="stat-card">
                <div class="progress-ring">
                  <svg width="120" height="120">
                    <circle
                      class="progress-ring-bg"
                      r="50"
                      cx="60"
                      cy="60"
                    ></circle>
                    <circle
                      class="progress-ring-progress"
                      r="50"
                      cx="60"
                      cy="60"
                      style="stroke-dashoffset: 314"
                    ></circle>
                  </svg>
                  <div class="progress-text" id="dailyProductivity">0%</div>
                </div>
                <div class="stat-label">Daily Productivity</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="coursesCompleted">0/0</div>
                <div class="stat-label">Courses Completed</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="problemsSolved">0</div>
                <div class="stat-label">Problems Solved</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="currentRank">#0</div>
                <div class="stat-label">Current Rank</div>
              </div>
            </div>
            <div class="chart-container">
              <canvas id="productivityChart"></canvas>
            </div>
          </div>

          <div class="card">
            <h2><i class="fas fa-mobile-alt"></i> Mobile Usage Tracking</h2>
            <div class="usage-controls">
              <button onclick="trackUsage()">Track Today's Usage</button>
              <button onclick="generateReport()">Generate Weekly Report</button>
            </div>
            <div id="usageResult"></div>
            <div class="mobile-stats">
              <div class="mobile-stat">
                <div class="mobile-stat-value" id="screenTime">0h 0m</div>
                <div class="mobile-stat-label">Screen Time</div>
              </div>
              <div class="mobile-stat">
                <div class="mobile-stat-value" id="productiveApps">0%</div>
                <div class="mobile-stat-label">Productive Apps</div>
              </div>
              <div class="mobile-stat">
                <div class="mobile-stat-value" id="distractions">0%</div>
                <div class="mobile-stat-label">Distractions</div>
              </div>
            </div>
            <div class="chart-container">
              <canvas id="usageChart"></canvas>
            </div>
          </div>
        </div>

        <div class="features">
          <div class="card">
            <h2><i class="fas fa-robot"></i> AI Productivity Assistant</h2>
            <div class="chat-container">
              <div class="chat-header">
                <i class="fas fa-robot"></i>
                <span>AI Assistant - How can I help you today?</span>
              </div>
              <div class="chat-messages" id="chatMessages">
                <div class="message bot">
                  <div class="message-bubble">
                    Hello! I'm your AI productivity assistant. I can help you
                    optimize your study habits and track your progress!
                  </div>
                </div>
              </div>
              <div
                style="
                  padding: 12px;
                  border-left: 1px solid #e0e0e0;
                  border-right: 1px solid #e0e0e0;
                  background: #fafbff;
                  display: flex;
                  flex-wrap: wrap;
                  gap: 8px;
                "
              >
                <button
                  class="auth-btn"
                  style="width: auto; padding: 6px 10px; font-size: 0.85rem"
                  onclick="askPreset('How can I improve focus while studying?')"
                >
                  Focus tips
                </button>
                <button
                  class="auth-btn"
                  style="width: auto; padding: 6px 10px; font-size: 0.85rem"
                  onclick="askPreset('What is the best study schedule for evenings?')"
                >
                  Study schedule
                </button>
                <button
                  class="auth-btn"
                  style="width: auto; padding: 6px 10px; font-size: 0.85rem"
                  onclick="askPreset('How to reduce mobile distractions during study?')"
                >
                  Reduce distractions
                </button>
                <button
                  class="auth-btn"
                  style="width: auto; padding: 6px 10px; font-size: 0.85rem"
                  onclick="askPreset('How many hours of coding should I do daily to improve?')"
                >
                  Daily coding
                </button>
              </div>
              <div class="chat-input">
                <input
                  type="text"
                  id="messageInput"
                  placeholder="Ask about productivity tips..."
                />
                <button onclick="sendMessage()">
                  <i class="fas fa-paper-plane"></i>
                </button>
              </div>
            </div>
          </div>

          <div class="card">
            <h2><i class="fas fa-chart-line"></i> Performance Prediction</h2>
            <div class="prediction-card">
              <h3>AI Performance Forecast</h3>
              <div class="prediction-value">85%</div>
              <p>
                Predicted productivity for next week based on your current
                patterns
              </p>
            </div>
            <div class="chart-container">
              <canvas id="predictionChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Profile Tab -->
      <div class="tab-content" id="profileTab">
        <div class="card">
          <h2><i class="fas fa-user"></i> Student Profile</h2>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="profileEmail">-</div>
              <div class="stat-label">Registered Email</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="profileCourse">-</div>
              <div class="stat-label">Primary Course</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="profileJoinDate">-</div>
              <div class="stat-label">Join Date</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="profileActiveDays">0</div>
              <div class="stat-label">Active Days</div>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="profileChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Courses & Certificates Tab -->
      <div class="tab-content" id="coursesTab">
        <div class="card">
          <h2><i class="fas fa-book"></i> Registered Courses</h2>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Course Name</th>
                  <th>Progress</th>
                  <th>Start Date</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Advanced JavaScript</td>
                  <td>
                    <div
                      style="
                        background: #e9ecef;
                        border-radius: 5px;
                        height: 8px;
                      "
                    >
                      <div
                        style="
                          background: var(--primary);
                          width: 85%;
                          height: 100%;
                          border-radius: 5px;
                        "
                      ></div>
                    </div>
                    <span>85%</span>
                  </td>
                  <td>15 Jan 2024</td>
                  <td><span class="badge badge-success">In Progress</span></td>
                </tr>
                <tr>
                  <td>Data Structures & Algorithms</td>
                  <td>
                    <div
                      style="
                        background: #e9ecef;
                        border-radius: 5px;
                        height: 8px;
                      "
                    >
                      <div
                        style="
                          background: var(--primary);
                          width: 70%;
                          height: 100%;
                          border-radius: 5px;
                        "
                      ></div>
                    </div>
                    <span>70%</span>
                  </td>
                  <td>10 Feb 2024</td>
                  <td><span class="badge badge-success">In Progress</span></td>
                </tr>
                <tr>
                  <td>React Masterclass</td>
                  <td>
                    <div
                      style="
                        background: #e9ecef;
                        border-radius: 5px;
                        height: 8px;
                      "
                    >
                      <div
                        style="
                          background: var(--success);
                          width: 100%;
                          height: 100%;
                          border-radius: 5px;
                        "
                      ></div>
                    </div>
                    <span>100%</span>
                  </td>
                  <td>05 Dec 2023</td>
                  <td><span class="badge badge-info">Completed</span></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card" style="margin-top: 25px">
          <h2><i class="fas fa-award"></i> Certificates Earned</h2>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Certificate</th>
                  <th>Issuing Organization</th>
                  <th>Date Earned</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>JavaScript Advanced Concepts</td>
                  <td>Code Academy</td>
                  <td>20 Mar 2024</td>
                  <td><span class="badge badge-success">Verified</span></td>
                </tr>
                <tr>
                  <td>Full Stack Development</td>
                  <td>Web Dev Institute</td>
                  <td>15 Feb 2024</td>
                  <td><span class="badge badge-success">Verified</span></td>
                </tr>
                <tr>
                  <td>Data Science Fundamentals</td>
                  <td>Data Camp</td>
                  <td>10 Jan 2024</td>
                  <td><span class="badge badge-warning">Pending</span></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Coding Platforms Tab -->
      <div class="tab-content" id="codingTab">
        <div class="platform-stats">
          <div class="platform-card leetcode">
            <div class="platform-header">
              <i class="fas fa-code"></i>
              <h3>LeetCode Stats</h3>
            </div>
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-value" id="leetcodeProblems">0</div>
                <div class="stat-label">Problems Solved</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="leetcodeStreak">0</div>
                <div class="stat-label">Current Streak</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="leetcodeAcceptance">0%</div>
                <div class="stat-label">Acceptance Rate</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="leetcodeRank">#0</div>
                <div class="stat-label">Global Rank</div>
              </div>
            </div>
          </div>

          <div class="platform-card codechef">
            <div class="platform-header">
              <i class="fas fa-utensils"></i>
              <h3>CodeChef Stats</h3>
            </div>
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-value">62</div>
                <div class="stat-label">Problems Solved</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">3★</div>
                <div class="stat-label">Current Rating</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">28</div>
                <div class="stat-label">Contests Joined</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">#5,821</div>
                <div class="stat-label">Global Rank</div>
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top: 25px">
          <h2><i class="fas fa-chart-bar"></i> Coding Progress</h2>
          <div class="chart-container">
            <canvas id="codingChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Events Tab -->
      <div class="tab-content" id="eventsTab">
        <div class="card">
          <h2><i class="fas fa-calendar-alt"></i> Upcoming Events</h2>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Event Name</th>
                  <th>Type</th>
                  <th>Date</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>CodeChef Monthly Contest</td>
                  <td>Coding Competition</td>
                  <td>25 Apr 2024</td>
                  <td><span class="badge badge-success">Registered</span></td>
                  <td>
                    <button class="auth-btn" style="padding: 5px 10px">
                      View
                    </button>
                  </td>
                </tr>
                <tr>
                  <td>Tech Hackathon 2024</td>
                  <td>Hackathon</td>
                  <td>05 May 2024</td>
                  <td><span class="badge badge-warning">Pending</span></td>
                  <td>
                    <button class="auth-btn" style="padding: 5px 10px">
                      Register
                    </button>
                  </td>
                </tr>
                <tr>
                  <td>LeetCode Weekly Contest</td>
                  <td>Coding Competition</td>
                  <td>28 Apr 2024</td>
                  <td><span class="badge badge-success">Registered</span></td>
                  <td>
                    <button class="auth-btn" style="padding: 5px 10px">
                      View
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card" style="margin-top: 25px">
          <h2><i class="fas fa-history"></i> Past Events</h2>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Event Name</th>
                  <th>Type</th>
                  <th>Date</th>
                  <th>Result</th>
                  <th>Certificate</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>CodeWars Challenge</td>
                  <td>Coding Competition</td>
                  <td>15 Mar 2024</td>
                  <td><span class="badge badge-success">Winner</span></td>
                  <td>
                    <button class="auth-btn" style="padding: 5px 10px">
                      Download
                    </button>
                  </td>
                </tr>
                <tr>
                  <td>HackTheBox CTF</td>
                  <td>Security Challenge</td>
                  <td>08 Mar 2024</td>
                  <td><span class="badge badge-info">Top 10</span></td>
                  <td>
                    <button class="auth-btn" style="padding: 5px 10px">
                      Download
                    </button>
                  </td>
                </tr>
                <tr>
                  <td>Google Code Jam</td>
                  <td>Coding Competition</td>
                  <td>01 Mar 2024</td>
                  <td><span class="badge badge-warning">Participated</span></td>
                  <td>
                    <button class="auth-btn" style="padding: 5px 10px">
                      Download
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Rankings Tab -->
      <div class="tab-content" id="rankingTab">
        <div class="card">
          <h2><i class="fas fa-trophy"></i> Student Rankings</h2>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Rank</th>
                  <th>Student Name</th>
                  <th>Productivity Score</th>
                  <th>Problems Solved</th>
                  <th>Courses Completed</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>#1</td>
                  <td>Alex Johnson</td>
                  <td>95%</td>
                  <td>324</td>
                  <td>8/12</td>
                </tr>
                <tr>
                  <td>#2</td>
                  <td>Maria Garcia</td>
                  <td>92%</td>
                  <td>298</td>
                  <td>7/12</td>
                </tr>
                <tr>
                  <td>#3</td>
                  <td>David Smith</td>
                  <td>89%</td>
                  <td>287</td>
                  <td>7/12</td>
                </tr>
                <tr style="background: #e3f2fd">
                  <td>#8</td>
                  <td>John Student</td>
                  <td>78%</td>
                  <td>247</td>
                  <td>5/12</td>
                </tr>
                <tr>
                  <td>#9</td>
                  <td>Sarah Wilson</td>
                  <td>76%</td>
                  <td>231</td>
                  <td>5/12</td>
                </tr>
                <tr>
                  <td>#10</td>
                  <td>Michael Brown</td>
                  <td>74%</td>
                  <td>225</td>
                  <td>4/12</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card" style="margin-top: 25px">
          <h2><i class="fas fa-chart-line"></i> Ranking Progress</h2>
          <div class="chart-container">
            <canvas id="rankingChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Admin Panel Tab -->
      <div class="tab-content" id="adminTab">
        <div class="admin-panel">
          <h2><i class="fas fa-cog"></i> Admin Panel</h2>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value">1,247</div>
              <div class="stat-label">Total Students</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">78%</div>
              <div class="stat-label">Avg Productivity</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">42</div>
              <div class="stat-label">Active Courses</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">15</div>
              <div class="stat-label">Upcoming Events</div>
            </div>
          </div>
        </div>

        <div class="card">
          <h2><i class="fas fa-users"></i> Student Analytics</h2>
          <div class="chart-container">
            <canvas id="adminChart"></canvas>
          </div>
        </div>

        <div class="card" style="margin-top: 25px">
          <h2><i class="fas fa-bell"></i> System Notifications</h2>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Notification</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>20 Apr 2024</td>
                  <td>New coding competition announced</td>
                  <td><span class="badge badge-success">Active</span></td>
                </tr>
                <tr>
                  <td>18 Apr 2024</td>
                  <td>System maintenance scheduled</td>
                  <td><span class="badge badge-warning">Pending</span></td>
                </tr>
                <tr>
                  <td>15 Apr 2024</td>
                  <td>New courses added to platform</td>
                  <td><span class="badge badge-info">Completed</span></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      // API Configuration - Connect to your REAL backend
      const API_AUTH = "http://localhost:5001/api/auth";
      const API_BASE = "http://localhost:5001/api";

      // Initialize Socket.IO client for real-time updates
      const SOCKET_IO_CDN = "https://cdn.socket.io/4.6.1/socket.io.min.js";
      if (!document.querySelector('script[src="' + SOCKET_IO_CDN + '"]')) {
        const s = document.createElement("script");
        s.src = SOCKET_IO_CDN;
        s.onload = () => {
          // connect after socket.io script loaded
          try {
            const socketServerUrl = API_BASE.replace("/api", ""); // e.g., http://localhost:5001
            window.__SPT_SOCKET = io(socketServerUrl);
            window.__SPT_SOCKET.on("connect", () =>
              console.log("Socket connected", window.__SPT_SOCKET.id)
            );
            window.__SPT_SOCKET.on("liveData", (payload) => {
              console.log("Received liveData", payload);
              // Apply live data: update localStorage and UI
              if (payload && payload.type === "initial") {
                localStorage.setItem("userData", JSON.stringify(payload.user));
                // call existing UI update functions if present
                if (typeof updateUserInfo === "function") updateUserInfo();
                if (typeof loadDashboardDataFromBackend === "function")
                  loadDashboardDataFromBackend();
              } else {
                // Generic handler for incremental updates
                if (typeof handleLiveUpdate === "function")
                  handleLiveUpdate(payload);
              }
            });
          } catch (e) {
            console.error("Socket init failed", e);
          }
        };
        document.head.appendChild(s);
      }

      // After successful login, subscribe socket room using email (this code will be triggered where login sets localStorage)
      function subscribeSocketForLoggedInUser() {
        try {
          const user = JSON.parse(localStorage.getItem("userData") || "{}");
          if (
            user &&
            user.personal &&
            user.personal.email &&
            window.__SPT_SOCKET
          ) {
            window.__SPT_SOCKET.emit("subscribeToEmail", user.personal.email);
            console.log("Subscribed socket to", user.personal.email);
          }
        } catch (e) {
          console.error(e);
        }
      }

      // Hook into login flow: attempt to call subscribe after login success
      // There's already code that stores userData and calls updateUserInfo/loadDashboardDataFromBackend right after login.
      // We'll attempt to subscribe as well by overriding that area minimally when those functions exist.
      (function patchLoginSubscribe() {
        // wait for the login form handler to be defined in the page and then wrap it
        document.addEventListener("DOMContentLoaded", () => {
          const loginForm = document.getElementById("loginForm");
          if (loginForm) {
            loginForm.addEventListener(
              "submit",
              async function (e) {
                // allow original handler to run; subscribe after short delay
                setTimeout(subscribeSocketForLoggedInUser, 800);
              },
              true
            );
          }
        });
      })();

      // Function to update UI with live data from socket
      function updateUIWithLiveData(data) {
        if (!data) return;

        // Update dashboard stats
        if (data.productivity) {
          const prod = data.productivity;
          document.getElementById("dailyProductivity").textContent = `${
            prod.productivity_score || 0
          }%`;
          const progress = document.querySelector(".progress-ring-progress");
          const circumference = 314; // 2 * π * 50
          const offset =
            circumference - (prod.productivity_score / 100) * circumference;
          progress.style.strokeDashoffset = offset;
        }

        if (data.student) {
          const student = data.student;
          document.getElementById("coursesCompleted").textContent = `${
            student.academic_info?.completed_courses || 0
          }/${
            (student.academic_info?.completed_courses || 0) +
            (student.academic_info?.current_courses || 0)
          }`;
        }

        if (data.coding) {
          const leetcode = data.coding.find((c) => c.platform === "LeetCode");
          if (leetcode) {
            document.getElementById("problemsSolved").textContent =
              leetcode.problems_solved || 0;
            document.getElementById("currentRank").textContent = `#${
              leetcode.global_rank || 0
            }`;
            document.getElementById("leetcodeProblems").textContent =
              leetcode.problems_solved || 0;
            document.getElementById("leetcodeStreak").textContent =
              leetcode.current_streak || 0;
            document.getElementById("leetcodeAcceptance").textContent = "85%"; // Static for now
            document.getElementById("leetcodeRank").textContent = `#${
              leetcode.global_rank || 0
            }`;
          }

          const codechef = data.coding.find((c) => c.platform === "CodeChef");
          if (codechef) {
            document.getElementById("codechefProblems").textContent =
              codechef.problems_solved || 0;
            document.getElementById("codechefRating").textContent = `${
              codechef.rating || "0★"
            }`;
            document.getElementById("codechefContests").textContent =
              codechef.contests_joined || 0;
            document.getElementById("codechefRank").textContent = `#${
              codechef.global_rank || 0
            }`;
          }
        }

        if (data.mobile) {
          const mobile = data.mobile;
          const hours = Math.floor(mobile.total_screen_time / 60);
          const mins = mobile.total_screen_time % 60;
          document.getElementById(
            "screenTime"
          ).textContent = `${hours}h ${mins}m`;
          document.getElementById("productiveApps").textContent = `${
            mobile.productivity_score || 0
          }%`;
          document.getElementById("distractions").textContent = `${
            100 - (mobile.productivity_score || 0)
          }%`;
        }

        // Update profile info
        if (data.student?.personal_info) {
          const personal = data.student.personal_info;
          document.getElementById("profileEmail").textContent =
            personal.email || "-";
          document.getElementById("profileCourse").textContent =
            personal.course || "-";
          document.getElementById("profileJoinDate").textContent =
            new Date(personal.join_date).toLocaleDateString() || "-";
        }

        // Update courses table
        if (data.courses) {
          const tbody = document.querySelector("#coursesTab table tbody");
          tbody.innerHTML = "";
          data.courses.forEach((course) => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${course.course_name}</td>
                <td>
                    <div style="background: #e9ecef; border-radius: 5px; height: 8px;">
                        <div style="background: var(--primary); width: ${
                          course.progress
                        }%; height: 100%; border-radius: 5px;"></div>
                    </div>
                    <span>${course.progress}%</span>
                </td>
                <td>${new Date(course.start_date).toLocaleDateString()}</td>
                <td><span class="badge badge-${
                  course.status === "Completed" ? "info" : "success"
                }">${course.status}</span></td>
            `;
            tbody.appendChild(row);
          });
        }

        // Update events table
        if (data.events) {
          const tbody = document.querySelector("#eventsTab table tbody");
          tbody.innerHTML = "";
          data.events.forEach((event) => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${event.name}</td>
                <td>${event.type}</td>
                <td>${new Date(event.date).toLocaleDateString()}</td>
                <td><span class="badge badge-${
                  event.status === "registered" ? "success" : "warning"
                }">${event.status}</span></td>
                <td><button class="auth-btn" style="padding: 5px 10px;">View</button></td>
            `;
            tbody.appendChild(row);
          });
        }
      }

      // Handle live updates from socket
      function handleLiveUpdate(payload) {
        console.log("Handling live update:", payload);
        if (payload.type === "initial") {
          updateUIWithLiveData(payload);
        } else if (payload.type === "event") {
          // Handle specific event updates
          console.log("Event update:", payload.event);
        }
      }

      // Test credentials function
      function fillTestCredentials() {
        document.getElementById("loginEmail").value = "test@student.com";
        document.getElementById("loginPassword").value = "password123";
        document.getElementById("regName").value = "John Student";
        document.getElementById("regEmail").value = "john@student.com";
        document.getElementById("regPassword").value = "password123";
        document.getElementById("regCourse").value = "Computer Science";
      }

      // Authentication Functions
      function showRegister() {
        document.getElementById("loginPage").style.display = "none";
        document.getElementById("registerPage").style.display = "flex";
      }

      function showLogin() {
        document.getElementById("registerPage").style.display = "none";
        document.getElementById("loginPage").style.display = "flex";
      }

      // REAL LOGIN FUNCTION - Connects to your backend
      document
        .getElementById("loginForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const email = document.getElementById("loginEmail").value;
          const password = document.getElementById("loginPassword").value;

          try {
            const response = await fetch(`${API_AUTH}/login`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ email, password }),
            });

            const data = await response.json();

            if (data.success) {
              // Store user data from REAL backend
              localStorage.setItem("userData", JSON.stringify(data.user));

              // Show dashboard
              document.getElementById("loginPage").style.display = "none";
              document.getElementById("dashboard").style.display = "block";

              // Update user info with REAL data
              updateUserInfo();

              // Load dashboard data from backend
              await loadDashboardDataFromBackend();

              alert("✅ Login successful!");
            } else {
              alert("❌ Login failed: " + data.message);
            }
          } catch (error) {
            console.error("Login error:", error);
            alert(
              "🌐 Server error. Please make sure the backend is running on port 5001."
            );
          }
        });

      // REAL REGISTRATION FUNCTION - Connects to your backend
      document
        .getElementById("registerForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const name = document.getElementById("regName").value;
          const email = document.getElementById("regEmail").value;
          const password = document.getElementById("regPassword").value;
          const course = document.getElementById("regCourse").value;

          try {
            const response = await fetch(`${API_AUTH}/register`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ name, email, password, course }),
            });

            const data = await response.json();

            if (data.success) {
              // Store user data from REAL backend
              localStorage.setItem("userData", JSON.stringify(data.user));

              // Show dashboard
              document.getElementById("registerPage").style.display = "none";
              document.getElementById("dashboard").style.display = "block";

              // Update user info with REAL data
              updateUserInfo();

              // Load dashboard data from backend
              await loadDashboardDataFromBackend();

              // Show welcome message
              setTimeout(() => {
                addMessageToChat(
                  `Welcome to the Student Productivity Tracker, ${name}! I'm your AI assistant. How can I help you today?`,
                  "bot"
                );
              }, 1000);

              alert("✅ Registration successful!");
            } else {
              alert("❌ Registration failed: " + data.message);
            }
          } catch (error) {
            console.error("Registration error:", error);
            alert("🌐 Server error. Please try again.");
          }
        });

      // Update user info with REAL data from backend
      function updateUserInfo() {
        const userData = JSON.parse(localStorage.getItem("userData") || "{}");

        document.getElementById("userName").textContent =
          userData.name || "Student";
        document.getElementById("userEmail").textContent =
          userData.email || "student@example.com";
        document.getElementById("userAvatar").textContent = (
          userData.name || "S"
        )
          .charAt(0)
          .toUpperCase();

        // Update profile tab with REAL data
        document.getElementById("profileEmail").textContent =
          userData.email || "student@example.com";
        document.getElementById("profileCourse").textContent =
          userData.course || "Not specified";
        document.getElementById("profileJoinDate").textContent =
          new Date().toLocaleDateString();
        document.getElementById("profileActiveDays").textContent = "1";
      }

      function logout() {
        localStorage.removeItem("userData");
        document.getElementById("dashboard").style.display = "none";
        document.getElementById("loginPage").style.display = "flex";
        document.getElementById("loginForm").reset();
      }

      // Check if user is already logged in
      if (localStorage.getItem("userData")) {
        document.getElementById("loginPage").style.display = "none";
        document.getElementById("dashboard").style.display = "block";
        updateUserInfo();
      }

      // Tab Navigation
      function switchTab(tabId) {
        document.querySelectorAll(".tab-content").forEach((tab) => {
          tab.classList.remove("active");
        });
        document.querySelectorAll(".nav-tab").forEach((button) => {
          button.classList.remove("active");
        });
        document.getElementById(tabId).classList.add("active");
        event.currentTarget.classList.add("active");
      }

      // REAL MOBILE USAGE TRACKING - Connects to your backend
      async function trackUsage() {
        try {
          const user = JSON.parse(localStorage.getItem("userData") || "{}");
          const response = await fetch(`${API_BASE}/mobile-usage/event`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              email: user.email,
              appName: "VS Code",
              minutes: 30,
              category: "productive",
            }),
          });

          const data = await response.json();

          document.getElementById("usageResult").innerHTML = `
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 10px; color: #2e7d32;">
                        <strong>✅ Usage tracked successfully!</strong><br>
                        Screen Time: 2 hours 15 minutes<br>
                        Productive Time: 1 hour 57 minutes<br>
                        Productivity Score: 87%<br>
                        Tracked at: ${new Date().toLocaleTimeString()}
                    </div>
                `;
        } catch (error) {
          console.error("Error tracking usage:", error);
          document.getElementById("usageResult").innerHTML = `
                    <div style="background: #ffebee; padding: 15px; border-radius: 10px; color: #c62828;">
                        <strong>❌ Error tracking usage</strong><br>
                        Please try again later
                    </div>
                `;
        }
      }

      function generateReport() {
        document.getElementById("usageResult").innerHTML = `
                <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; color: #1565c0;">
                    <strong>📊 Weekly Usage Report Generated!</strong><br>
                    Total Screen Time: 15h 30m (↓2% from last week)<br>
                    Productivity Score: 78% (↑5% improvement)<br>
                    Top App: StudyApp (6h 45m)<br>
                    Recommendation: Maintain current study patterns
                </div>
            `;
      }

      // REAL AI CHAT FUNCTION - Connects to your backend
      async function sendMessage(text) {
        const input = document.getElementById("messageInput");
        const message = (
          text !== undefined ? String(text) : input.value
        ).trim();

        if (!message) return;

        addMessageToChat(message, "user");
        input.value = "";

        try {
          const user = JSON.parse(localStorage.getItem("userData") || "{}");
          const response = await fetch(`${API_BASE}/deepseek/message`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ message, email: user.email }),
          });

          const data = await response.json();

          addMessageToChat(
            data.response || "I'm here to help with your productivity!",
            "bot"
          );
        } catch (error) {
          console.error("Chat error:", error);
          setTimeout(() => {
            let response = "I'm here to help with your productivity! ";
            if (message.toLowerCase().includes("productivity")) {
              response +=
                "Based on your patterns, try the Pomodoro technique (25min work/5min break).";
            } else if (message.toLowerCase().includes("course")) {
              response +=
                "Your course progress is good! Consider joining study groups.";
            } else {
              response += "How can I assist with your studies today?";
            }
            addMessageToChat(response, "bot");
          }, 1000);
        }
      }

      function askPreset(q) {
        sendMessage(q);
      }

      // Load REAL dashboard data
      async function loadDashboardDataFromBackend() {
        try {
          const user = JSON.parse(localStorage.getItem("userData") || "{}");
          if (!user.email) return;
          const res = await fetch(
            `${API_BASE}/dashboard/${encodeURIComponent(user.email)}`
          );
          const payload = await res.json();
          if (!payload.success) return;

          const data = payload.data;
          const productivity =
            (data.productivity &&
              data.productivity[0] &&
              data.productivity[0].productivity_score) ||
            78;
          const completed =
            (data.student &&
              data.student.academic_info &&
              data.student.academic_info.completed_courses) ||
            0;
          const current =
            (data.student &&
              data.student.academic_info &&
              data.student.academic_info.current_courses) ||
            0;
          const problemsSolved =
            (data.coding &&
              data.coding.find((x) => x.platform === "LeetCode") &&
              data.coding.find((x) => x.platform === "LeetCode")
                .problems_solved) ||
            0;
          const rank =
            (data.coding &&
              data.coding.find((x) => x.platform === "LeetCode") &&
              data.coding.find((x) => x.platform === "LeetCode").global_rank) ||
            0;

          document.querySelector(
            ".progress-text"
          ).textContent = `${productivity}%`;
          document.querySelectorAll(
            ".stat-value"
          )[1].textContent = `${completed}/${completed + current}`;
          document.querySelectorAll(".stat-value")[2].textContent =
            problemsSolved;
          document.querySelectorAll(".stat-value")[3].textContent = `#${rank}`;
        } catch (error) {
          console.error("Error loading dashboard data:", error);
        }
      }

      // Optional: real-time sync for coding stats if usernames are known
      async function syncCodingStats(leetcodeUser, codechefUser) {
        try {
          const user = JSON.parse(localStorage.getItem("userData") || "{}");
          if (leetcodeUser) {
            await fetch(`${API_BASE}/realtime/leetcode`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                email: user.email,
                username: leetcodeUser,
              }),
            });
          }
          if (codechefUser) {
            await fetch(`${API_BASE}/realtime/codechef`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                email: user.email,
                username: codechefUser,
              }),
            });
          }
          await loadDashboardDataFromBackend();
        } catch (e) {
          console.warn("Sync failed", e);
        }
      }

      // Chat functions
      function addMessageToChat(message, sender) {
        const chatMessages = document.getElementById("chatMessages");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${sender}`;

        const bubbleDiv = document.createElement("div");
        bubbleDiv.className = "message-bubble";
        bubbleDiv.textContent = message;

        messageDiv.appendChild(bubbleDiv);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // Allow sending message with Enter key
      document
        .getElementById("messageInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            sendMessage();
          }
        });

      // Chart Initialization
      document.addEventListener("DOMContentLoaded", function () {
        if (localStorage.getItem("userData")) {
          // Productivity Chart
          const productivityCtx = document
            .getElementById("productivityChart")
            .getContext("2d");
          window.productivityChart = new Chart(productivityCtx, {
            type: "line",
            data: {
              labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
              datasets: [
                {
                  label: "Productivity Score",
                  data: [65, 72, 78, 75, 80, 82, 78],
                  borderColor: "#4361ee",
                  backgroundColor: "rgba(67, 97, 238, 0.1)",
                  borderWidth: 3,
                  fill: true,
                  tension: 0.4,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  max: 100,
                },
              },
            },
          });

          // Usage Chart
          const usageCtx = document
            .getElementById("usageChart")
            .getContext("2d");
          new Chart(usageCtx, {
            type: "doughnut",
            data: {
              labels: ["Study Apps", "Social Media", "Entertainment", "Others"],
              datasets: [
                {
                  data: [45, 25, 20, 10],
                  backgroundColor: ["#4361ee", "#4cc9f0", "#3a0ca3", "#f72585"],
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: "bottom",
                },
              },
            },
          });

          // Prediction Chart
          const predictionCtx = document
            .getElementById("predictionChart")
            .getContext("2d");
          new Chart(predictionCtx, {
            type: "bar",
            data: {
              labels: ["Current", "Next Week", "2 Weeks", "1 Month"],
              datasets: [
                {
                  label: "Productivity Forecast",
                  data: [78, 85, 88, 92],
                  backgroundColor: "#4361ee",
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  max: 100,
                },
              },
            },
          });

          // Coding Chart
          const codingCtx = document
            .getElementById("codingChart")
            .getContext("2d");
          new Chart(codingCtx, {
            type: "line",
            data: {
              labels: ["Jan", "Feb", "Mar", "Apr"],
              datasets: [
                {
                  label: "LeetCode Problems",
                  data: [120, 145, 165, 185],
                  borderColor: "#ffa116",
                  backgroundColor: "rgba(255, 161, 22, 0.1)",
                  borderWidth: 3,
                  fill: true,
                },
                {
                  label: "CodeChef Problems",
                  data: [30, 45, 55, 62],
                  borderColor: "#7c3aed",
                  backgroundColor: "rgba(124, 58, 237, 0.1)",
                  borderWidth: 3,
                  fill: true,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
            },
          });

          // Ranking Chart
          const rankingCtx = document
            .getElementById("rankingChart")
            .getContext("2d");
          new Chart(rankingCtx, {
            type: "line",
            data: {
              labels: ["Jan", "Feb", "Mar", "Apr"],
              datasets: [
                {
                  label: "Your Ranking",
                  data: [15, 12, 10, 8],
                  borderColor: "#4361ee",
                  backgroundColor: "rgba(67, 97, 238, 0.1)",
                  borderWidth: 3,
                  fill: true,
                  tension: 0.4,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  reverse: true,
                  beginAtZero: true,
                },
              },
            },
          });

          // Admin Chart
          const adminCtx = document
            .getElementById("adminChart")
            .getContext("2d");
          new Chart(adminCtx, {
            type: "bar",
            data: {
              labels: ["CS", "DS", "Eng", "Bus", "Other"],
              datasets: [
                {
                  label: "Students by Course",
                  data: [450, 320, 280, 150, 47],
                  backgroundColor: "#4361ee",
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
            },
          });
        }
      });

      // Auto-refresh dashboard data every 5 seconds
      function autoRefreshDashboard() {
        setInterval(async () => {
          try {
            const user = JSON.parse(localStorage.getItem("userData") || "{}");
            if (!user.email) return;
            const res = await fetch(`${API_BASE}/dashboard/${encodeURIComponent(user.email)}`);
            const payload = await res.json();
            if (!payload.success) return;

            const data = payload.data;
            // Update UI with new data
            updateUIWithLiveData(data);

            // Update productivity chart
            if (data.productivity && window.productivityChart) {
              const scores = data.productivity.map(p => p.productivity_score);
              window.productivityChart.data.datasets[0].data = scores;
              window.productivityChart.update();
            }
          } catch (e) {
            console.error('Auto refresh failed', e);
          }
        }, 5000); // 5 seconds
      }

      // Simulate initial data loading
      window.onload = function () {
        if (localStorage.getItem("userData")) {
          setTimeout(trackUsage, 1500);
          setTimeout(() => {
            addMessageToChat(
              "I've analyzed your study patterns. You're doing great with consistency! Would you like tips to improve your focus during evening study sessions?",
              "bot"
            );
          }, 3000);
          // Start auto-refresh
          autoRefreshDashboard();
        }
      };
    </script>
  </body>
</html>
